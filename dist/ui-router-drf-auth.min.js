/*!
 * ui-router-drf-auth
 * 
 * Version: 0.1.0 - 2014-11-03T17:13:16.960Z
 * License: 
 */
angular.module("urda",[]).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized",loginRequired:"auth-login-required"}).provider("urdaConfig",function(){this.loginUrl=null,this.tokenUrl=null,this.servervaluesUrl=null,this.mode=null,this.apiAuthMode=null,this.$get=function(){this.url;return{formLoginUrl:this.formLoginUrl,tokenUrl:this.tokenUrl,socialLoginUrl:this.socialLoginUrl,mode:this.modem,apiAuthMode:this.apiAuthMode}},this.setFormLoginUrl=function(t){this.formLoginUrl=t},this.setTokenUrl=function(t){this.tokenUrl=t},this.setSocialLoginUrl=function(t){this.socialLoginUrl=t},this.setMode=function(t){this.mode=t},this.setApiAuthMode=function(t){this.apiAuthMode=t}}).service("urdaSession",["urdaConfig",function(){this.create=function(t){this.sessionData=t},this.destroy=function(){this.sessionData=null}}]).factory("urdaService",["$rootScope","$http","$q","AUTH_EVENTS","urdaSession","urdaConfig","$cookieStore","$window","$timeout","$location",function(t,e,o,n,i,r){{var u={},s=r.loginUrl,a=r.tokenUrl;r.servervaluesUrl}u.csrfToken=null;var c=function(){if("token"==r.apiAuthMode&&(e.defaults.headers.common.Authorization="Token "+DrfSession.sessionData.token),"session"==r.apiAuthMode)throw Error("Hey no session now...");t.$broadcast(n.loginSuccess)},f=function(){console.log("login error detected"),i.destroy(),t.$broadcast(n.loginFailed)},d=function(){if("token"==r.apiAuthMode&&(delete e.defaults.headers.common.Authorization,DrfSession.destroy()),"session"==r.apiAuthMode)throw Error("Hey no session now...");t.$broadcast(n.logoutSuccess)},h=function(t){return e.post(a,t).error(function(){f()}).then(function(t){return DrfSession.create(t.data),c(),t})},l=function(t){socialAuthLogin.loginDjango(t.provider).then(function(t){return DrfSession.create({token:t}),c(),res}).catch(function(){f()})};return u.getCrf=function(){var t=o.defer();return e.get(s).then(function(o){var n=$(o.data).find("input[name='csrfmiddlewaretoken']");if(n.length){var i=n.val();e.defaults.headers.common["X-CSRFToken"]=i,u.csrfToken=i,t.resolve(i)}}),t.promise},u.login=function(t){if("social"==r.mode)return l(t);if("token"==r.mode)return h(t);throw"form"!=r.mode||csrfToken||u.getCrf().then(function(e){return t.csrfmiddlewaretoken=e,loginForm(t)}),Error("mode must be form, social or token")},u.logout=function(){return d()},u.isAuthenticated=function(){return!!DrfSession.sessionData},u.checkRoute=function(e,o,i){if(e.auth){e.auth.requiresAuth&&(u.isAuthenticated()||(i&&i.preventDefault(),t.$broadcast(n.notAuthenticated,e,o)));var r=e.auth.authorizedRoles;r&&(u.isAuthorized(r)||(i&&i.preventDefault(),t.$broadcast(u.isAuthenticated()?n.notAuthorized:n.notAuthenticated)))}},u.forceLoginRoute=function(e,o,i,r){if(-1==r.indexOf(e.name)){if(!u.isAuthenticated())return i&&i.preventDefault(),t.$broadcast(n.notAuthenticated,e,o),!1;if(!e.auth)return!0;var s=e.auth.authorizedRoles;s&&(u.isAuthorized(s)||(i&&i.preventDefault(),t.$broadcast(u.isAuthenticated()?n.notAuthorized:n.notAuthenticated)))}},u}]).config(["$httpProvider",function(t){t.interceptors.push(["AUTH_EVENTS","$rootScope","$q","httpBuffer",function(t,e,o,n){return{responseError:function(i){var r={401:t.notAuthenticated,403:t.notAuthorized,419:t.sessionTimeout,440:t.sessionTimeout},u=r[i.status]||t.loginRequired;if(e.$broadcast(u,i),401===i.status&&!i.config.ignoreAuthModule){var s=o.defer();return n.append(i.config,s),e.$broadcast(u,i),s.promise}return o.reject(i)}}}])}]),angular.module("http-auth-interceptor-buffer",[]).factory("httpBuffer",["$injector",function(t){function e(e,n){function i(t){n.resolve(t)}function r(t){n.reject(t)}o=o||t.get("$http"),o(e).then(i,r)}var o,n=[];return{append:function(t,e){n.push({config:t,deferred:e})},rejectAll:function(t){if(t)for(var e=0;e<n.length;++e)n[e].deferred.reject(t);n=[]},retryAll:function(t){for(var o=0;o<n.length;++o)e(t(n[o].config),n[o].deferred);n=[]}}}]);